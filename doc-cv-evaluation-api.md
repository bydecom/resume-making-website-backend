# Tài liệu API Đánh giá CV

## Tổng quan

Hệ thống API cho phép quản lý CV của người dùng và cung cấp tính năng đánh giá CV thông qua các chỉ số: Score, Progress, Strengths và Improvements. Hệ thống hỗ trợ cả đánh giá thủ công và đánh giá tự động sử dụng AI (Gemini API).

## Xác thực

Tất cả các API đều yêu cầu xác thực qua JWT Token.

- **Authorization Header**: `Bearer [jwt_token]`

## API Đánh giá CV

### 1. Đánh giá CV từ dữ liệu frontend (Mới)

- **Endpoint**: `POST /api/cv/evaluate-from-data`
- **Access**: Private (yêu cầu JWT)
- **Description**: Sử dụng AI để đánh giá CV dựa trên dữ liệu gửi từ frontend

**Request Body**:
```json
{
  "cvData": {
    "personalInfo": {
      "firstName": "John",
      "lastName": "Doe",
      "email": "john.doe@example.com",
      "phone": "+84123456789",
      "location": "Ho Chi Minh City",
      "country": "Vietnam"
    },
    "summary": "Experienced software developer with 5+ years in web development",
    "education": [
      {
        "degree": "Bachelor of Computer Science",
        "school": "Vietnam National University",
        "startDate": "2015-09-01",
        "endDate": "2019-06-30",
        "isPresent": false
      }
    ],
    "experience": [
      {
        "title": "Senior Developer",
        "company": "Tech Solutions Inc.",
        "startDate": "2020-01-01",
        "endDate": null,
        "isPresent": true,
        "description": "Leading front-end development team"
      }
    ],
    "skills": ["JavaScript", "React", "Node.js"],
    "projects": [
      {
        "title": "E-commerce Platform",
        "role": "Frontend Lead",
        "startDate": "2021-03-01",
        "endDate": "2021-08-30",
        "description": "Developed responsive UI components",
        "isPresent": false
      }
    ]
  },
  "cvId": "6123abc456def7890123456"  // Optional: Chỉ cần nếu muốn lưu đánh giá vào database
}
```

**Success Response** (200):
```json
{
  "status": "success",
  "data": {
    "score": 75,
    "progress": 80,
    "strengths": [
      "Strong technical skills section",
      "Clear work history with good chronology",
      "Education section shows relevant qualifications",
      "Well-formatted contact information"
    ],
    "improvements": [
      "Add more quantifiable achievements in work history",
      "Expand professional summary to highlight key strengths",
      "Include relevant certifications",
      "Add more industry-specific keywords"
    ],
    "isAutoGenerated": true,
    "evaluationDate": "2024-04-15T10:30:45.123Z"
  },
  "message": "CV evaluated automatically"
}
```

**Lưu ý**:
- Nếu cung cấp `cvId` và CV được tìm thấy trong database, kết quả đánh giá sẽ được lưu vào database.
- Nếu không cung cấp `cvId`, kết quả đánh giá chỉ được trả về mà không lưu vào database.

### 2. Tạo/Cập nhật đánh giá cho CV

- **Endpoint**: `POST /api/cv/:cvId/evaluation`
- **Access**: Private (yêu cầu JWT)
- **Parameters**:
  - `cvId`: ID của CV
  
**Request Body**:
```json
{
  "score": 80,
  "progress": 85,
  "strengths": [
    "Clear and concise work history",
    "Well-organized skills section",
    "Professional summary highlights key qualifications"
  ],
  "improvements": [
    "Add more quantifiable achievements",
    "Include more industry-specific keywords",
    "Expand education details"
  ]
}
```

**Success Response** (201/200):
```json
{
  "status": "success",
  "data": {
    "_id": "evaluation_id",
    "cv": "cv_id",
    "score": 80,
    "progress": 85,
    "strengths": [...],
    "improvements": [...],
    "isAutoGenerated": false,
    "evaluationDate": "2024-04-15T10:30:45.123Z",
    "createdAt": "2024-04-15T10:30:45.123Z",
    "updatedAt": "2024-04-15T10:30:45.123Z"
  },
  "message": "CV evaluation created/updated successfully"
}
```

### 3. Tạo đánh giá tự động sử dụng AI (từ database)

- **Endpoint**: `POST /api/cv/:cvId/auto-evaluation`
- **Access**: Private (yêu cầu JWT)
- **Parameters**:
  - `cvId`: ID của CV
- **Description**: Lấy dữ liệu CV từ database và sử dụng AI để tự động đánh giá

**Request Body**: Không cần

**Success Response** (200):
```json
{
  "status": "success",
  "data": {
    "_id": "evaluation_id",
    "cv": "cv_id",
    "score": 75,
    "progress": 80,
    "strengths": [...],
    "improvements": [...],
    "isAutoGenerated": true,
    "evaluationDate": "2024-04-15T10:30:45.123Z",
    "createdAt": "2024-04-15T10:30:45.123Z",
    "updatedAt": "2024-04-15T10:30:45.123Z"
  },
  "message": "CV evaluated automatically"
}
```

### 4. Lấy đánh giá của một CV

- **Endpoint**: `GET /api/cv/:cvId/evaluation`
- **Access**: Private (yêu cầu JWT)
- **Parameters**:
  - `cvId`: ID của CV
  
**Success Response** (200):
```json
{
  "status": "success",
  "data": {
    "_id": "evaluation_id",
    "cv": "cv_id",
    "score": 75,
    "progress": 80,
    "strengths": [...],
    "improvements": [...],
    "isAutoGenerated": true,
    "evaluationDate": "2024-04-15T10:30:45.123Z",
    "createdAt": "2024-04-15T10:30:45.123Z",
    "updatedAt": "2024-04-15T10:30:45.123Z"
  },
  "message": "CV evaluation retrieved successfully"
}
```

### 5. Lấy danh sách CV kèm đánh giá (Cập nhật)

- **Endpoint**: `GET /api/cv`
- **Access**: Private (yêu cầu JWT)
- **Description**: Lấy danh sách CV của người dùng kèm theo đánh giá (nếu có)

**Query Parameters**:
- `page`: Số trang (mặc định: 1)
- `limit`: Số lượng CV trên mỗi trang (mặc định: 10)

**Success Response** (200):
```json
{
  "status": "success",
  "data": [
    {
      "_id": "cv_id_1",
      "name": "My Professional CV 2024",
      "createdAt": "2024-04-15T10:30:45.123Z",
      "updatedAt": "2024-04-15T10:30:45.123Z",
      "status": "published",
      "isDefault": true,
      "template": "modern",
      "evaluation": {
        "_id": "evaluation_id_1",
        "cv": "cv_id_1",
        "score": 85,
        "progress": 92,
        "strengths": [
          "Strong technical skills section",
          "Clear work history with quantifiable achievements",
          "Well-structured education section"
        ],
        "improvements": [
          "Add more keywords relevant to target industry",
          "Expand professional summary",
          "Include more projects with measurable results"
        ],
        "isAutoGenerated": true,
        "evaluationDate": "2024-04-15T10:30:45.123Z",
        "createdAt": "2024-04-15T10:30:45.123Z",
        "updatedAt": "2024-04-15T10:30:45.123Z"
      }
    },
    {
      "_id": "cv_id_2",
      "name": "Creative CV",
      "createdAt": "2024-04-10T08:20:15.456Z",
      "updatedAt": "2024-04-12T14:45:30.789Z",
      "status": "draft",
      "isDefault": false,
      "template": "creative",
      "evaluation": null  // Chưa có đánh giá
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 2,
    "pages": 1
  },
  "message": "CVs retrieved successfully"
}
```

### 6. Lấy thông tin chi tiết CV kèm đánh giá (Cập nhật)

- **Endpoint**: `GET /api/cv/:id`
- **Access**: Private (yêu cầu JWT)
- **Parameters**:
  - `id`: ID của CV
- **Description**: Lấy thông tin chi tiết của CV kèm theo đánh giá (nếu có)

**Success Response** (200):
```json
{
  "status": "success",
  "data": {
    "_id": "cv_id_1",
    "name": "My Professional CV 2024",
    "personalInfo": {
      "firstName": "John",
      "lastName": "Doe",
      "email": "john.doe@example.com",
      "phone": "+84123456789",
      "location": "Ho Chi Minh City",
      "country": "Vietnam"
    },
    "summary": "Experienced software developer with 5+ years in web development",
    "education": [...],
    "experience": [...],
    "skills": ["JavaScript", "React", "Node.js"],
    "projects": [...],
    "certifications": [...],
    "languages": [...],
    "additionalInfo": {...},
    "customFields": [...],
    "status": "published",
    "isDefault": true,
    "template": "modern",
    "createdAt": "2024-04-15T10:30:45.123Z",
    "updatedAt": "2024-04-15T10:30:45.123Z",
    "evaluation": {
      "_id": "evaluation_id_1",
      "cv": "cv_id_1",
      "score": 85,
      "progress": 92,
      "strengths": [
        "Strong technical skills section",
        "Clear work history with quantifiable achievements",
        "Well-structured education section"
      ],
      "improvements": [
        "Add more keywords relevant to target industry",
        "Expand professional summary",
        "Include more projects with measurable results"
      ],
      "isAutoGenerated": true,
      "evaluationDate": "2024-04-15T10:30:45.123Z",
      "createdAt": "2024-04-15T10:30:45.123Z",
      "updatedAt": "2024-04-15T10:30:45.123Z"
    }
  },
  "message": "CV retrieved successfully"
}
```

## Mã lỗi

Khi xảy ra lỗi, API sẽ trả về cấu trúc chung như sau:

```json
{
  "status": "error",
  "code": "ERROR_CODE",
  "message": "Error description"
}
```

### Các mã lỗi phổ biến:

- **VALIDATION_ERROR**: Dữ liệu không hợp lệ
- **INVALID_DATA**: Dữ liệu CV không hợp lệ
- **CV_NOT_FOUND**: CV không tồn tại hoặc không thuộc về người dùng hiện tại
- **EVALUATION_NOT_FOUND**: Chưa có đánh giá cho CV này
- **AI_EVALUATION_ERROR**: Lỗi khi tạo đánh giá tự động bằng AI
- **CONFIG_ERROR**: Lỗi cấu hình (ví dụ: thiếu Gemini API key)
- **SERVER_ERROR**: Lỗi máy chủ

## Hướng dẫn tích hợp cho Frontend

### 1. Đánh giá CV từ dữ liệu trên form hiện tại (không lưu trên server)

```javascript
async function evaluateCVFromCurrentData() {
  try {
    const token = localStorage.getItem('token');
    
    // Lấy dữ liệu CV hiện tại từ form
    const cvData = {
      personalInfo: {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        location: document.getElementById('location').value,
        country: document.getElementById('country').value
      },
      summary: document.getElementById('summary').value,
      skills: getSkillsFromForm(),
      education: getEducationFromForm(),
      experience: getExperienceFromForm(),
      // Các trường khác...
    };
    
    // Hiển thị loading spinner
    showLoading(true);
    
    const response = await fetch('/api/cv/evaluate-from-data', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ cvData })
    });
    
    const data = await response.json();
    showLoading(false);
    
    if (data.status === 'success') {
      // Hiển thị kết quả đánh giá
      displayEvaluation(data.data);
    } else {
      // Xử lý lỗi
      showError(data.message);
    }
  } catch (error) {
    showLoading(false);
    console.error('Error evaluating CV:', error);
    showError('Failed to evaluate CV. Please try again later.');
  }
}

// Hiển thị kết quả đánh giá
function displayEvaluation(evaluation) {
  const modalContent = document.getElementById('evaluation-results');
  
  // Hiển thị điểm và tiến độ
  document.getElementById('cv-score').textContent = evaluation.score;
  document.getElementById('cv-progress').textContent = `${evaluation.progress}%`;
  document.getElementById('progress-bar-inner').style.width = `${evaluation.progress}%`;
  
  // Hiển thị điểm mạnh
  const strengthsList = document.getElementById('strengths-list');
  strengthsList.innerHTML = '';
  evaluation.strengths.forEach(strength => {
    const item = document.createElement('li');
    item.textContent = strength;
    strengthsList.appendChild(item);
  });
  
  // Hiển thị gợi ý cải thiện
  const improvementsList = document.getElementById('improvements-list');
  improvementsList.innerHTML = '';
  evaluation.improvements.forEach(improvement => {
    const item = document.createElement('li');
    item.textContent = improvement;
    improvementsList.appendChild(item);
  });
  
  // Hiển thị modal đánh giá
  openEvaluationModal();
}
```

### 2. Đánh giá CV và lưu kết quả vào database

```javascript
async function evaluateAndSaveCV() {
  try {
    const token = localStorage.getItem('token');
    const cvId = document.getElementById('cv-id').value;
    
    // Lấy dữ liệu CV hiện tại từ form
    const cvData = {
      personalInfo: {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        location: document.getElementById('location').value,
        country: document.getElementById('country').value
      },
      summary: document.getElementById('summary').value,
      skills: getSkillsFromForm(),
      education: getEducationFromForm(),
      experience: getExperienceFromForm(),
      // Các trường khác...
    };
    
    // Hiển thị loading spinner
    showLoading(true);
    
    const response = await fetch('/api/cv/evaluate-from-data', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        cvData,
        cvId // Gửi cvId để lưu kết quả vào database
      })
    });
    
    const data = await response.json();
    showLoading(false);
    
    if (data.status === 'success') {
      // Hiển thị thông báo thành công
      showSuccess('CV evaluated and saved successfully');
      
      // Hiển thị kết quả đánh giá
      displayEvaluation(data.data);
    } else {
      // Xử lý lỗi
      showError(data.message);
    }
  } catch (error) {
    showLoading(false);
    console.error('Error evaluating CV:', error);
    showError('Failed to evaluate CV. Please try again later.');
  }
}
```

### 3. Lấy đánh giá của một CV

```javascript
async function getCVEvaluation(cvId) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`/api/cv/${cvId}/evaluation`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      // Hiển thị chi tiết đánh giá
      displayEvaluation(data.data);
      return data.data;
    } else if (data.code === 'EVALUATION_NOT_FOUND') {
      // CV chưa có đánh giá, hiển thị nút đánh giá
      showEvaluateButton(cvId);
      return null;
    } else {
      // Xử lý lỗi khác
      showError(data.message);
      return null;
    }
  } catch (error) {
    console.error('Error getting CV evaluation:', error);
    showError('Failed to get CV evaluation. Please try again later.');
    return null;
  }
}
```

### 4. Lấy danh sách CV kèm đánh giá (Mới)

```javascript
async function getCVListWithEvaluations() {
  try {
    const token = localStorage.getItem('token');
    const page = getCurrentPage(); // Hàm lấy trang hiện tại
    const limit = getItemsPerPage(); // Hàm lấy số lượng item mỗi trang
    
    const response = await fetch(`/api/cv?page=${page}&limit=${limit}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      // Hiển thị danh sách CV kèm đánh giá
      displayCVList(data.data);
      setupPagination(data.pagination);
      return data.data;
    } else {
      // Xử lý lỗi
      showError(data.message);
      return [];
    }
  } catch (error) {
    console.error('Error getting CV list:', error);
    showError('Failed to get CV list. Please try again later.');
    return [];
  }
}

// Hiển thị danh sách CV kèm đánh giá
function displayCVList(cvs) {
  const cvListContainer = document.getElementById('cv-list');
  cvListContainer.innerHTML = '';
  
  cvs.forEach(cv => {
    const cvCard = document.createElement('div');
    cvCard.className = 'cv-card';
    
    // Hiển thị thông tin cơ bản CV
    const cvInfo = document.createElement('div');
    cvInfo.className = 'cv-info';
    cvInfo.innerHTML = `
      <h3>${cv.name}</h3>
      <p>Status: ${cv.status}</p>
      <p>Updated: ${new Date(cv.updatedAt).toLocaleDateString()}</p>
    `;
    
    // Hiển thị thông tin đánh giá nếu có
    const evaluationInfo = document.createElement('div');
    if (cv.evaluation) {
      evaluationInfo.className = 'evaluation-info';
      evaluationInfo.innerHTML = `
        <div class="score-container">
          <div class="score-value">${cv.evaluation.score}</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${cv.evaluation.progress}%"></div>
          </div>
          <div class="progress-label">${cv.evaluation.progress}% complete</div>
        </div>
        <button class="view-details-btn" data-id="${cv._id}">View Details</button>
      `;
    } else {
      evaluationInfo.className = 'no-evaluation';
      evaluationInfo.innerHTML = `
        <p>No evaluation yet</p>
        <button class="evaluate-btn" data-id="${cv._id}">Evaluate CV</button>
      `;
    }
    
    // Thêm các sự kiện cho nút
    cvCard.appendChild(cvInfo);
    cvCard.appendChild(evaluationInfo);
    cvListContainer.appendChild(cvCard);
  });
  
  // Thêm event listeners cho các nút
  document.querySelectorAll('.view-details-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const cvId = btn.getAttribute('data-id');
      viewCVDetails(cvId);
    });
  });
  
  document.querySelectorAll('.evaluate-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const cvId = btn.getAttribute('data-id');
      evaluateCV(cvId);
    });
  });
}
```

### 5. Lấy thông tin chi tiết CV kèm đánh giá (Mới)

```javascript
async function getCVDetailsWithEvaluation(cvId) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`/api/cv/${cvId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      // Hiển thị chi tiết CV và đánh giá (nếu có)
      displayCVDetails(data.data);
      
      // Nếu có đánh giá, hiển thị thông tin đánh giá
      if (data.data.evaluation) {
        displayEvaluation(data.data.evaluation);
      } else {
        // Hiển thị nút để đánh giá CV
        showEvaluateButton(cvId);
      }
      
      return data.data;
    } else {
      // Xử lý lỗi
      showError(data.message);
      return null;
    }
  } catch (error) {
    console.error('Error getting CV details:', error);
    showError('Failed to get CV details. Please try again later.');
    return null;
  }
}
```

## Quy trình hoạt động gợi ý

1. Khi người dùng đang chỉnh sửa CV và muốn đánh giá trước khi lưu:
   - Gọi API `POST /api/cv/evaluate-from-data` không kèm cvId
   - Hiển thị kết quả đánh giá trong modal hoặc sidebar

2. Khi người dùng đã lưu CV và muốn đánh giá:
   - Gọi API `POST /api/cv/evaluate-from-data` kèm cvId
   - Hoặc gọi API `POST /api/cv/:cvId/auto-evaluation` nếu muốn sử dụng dữ liệu từ server

3. Khi hiển thị danh sách CV:
   - Gọi API `GET /api/cv` sẽ trả về danh sách CV kèm thông tin đánh giá (nếu có)
   - Hiển thị score và progress nếu đã có đánh giá
   - Hiển thị nút "Evaluate" nếu chưa có đánh giá

4. Khi xem chi tiết một CV:
   - Gọi API `GET /api/cv/:id` để lấy thông tin đầy đủ của CV kèm đánh giá (nếu có)
   - Hiển thị đầy đủ thông tin CV và đánh giá trong cùng một trang 

### Example Request Body:
```json
{
  "jobDescription": {
    "position": "Senior Software Engineer",
    "companyName": "Tech Corp",
    "department": "Engineering",
    "location": "Ho Chi Minh City",
    "jobLevel": "Senior",
    "employmentType": "Full-time",
    "summary": "We are looking for a Senior Software Engineer...",
    "responsibilities": [
      "Lead development of complex features",
      "Mentor junior developers"
    ],
    "requirements": [
      "5+ years of experience in software development",
      "Strong knowledge of JavaScript and Node.js"
    ],
    "preferredQualifications": [
      "Experience with AWS",
      "Knowledge of microservices architecture"
    ],
    "skillsRequired": [
      "Node.js",
      "React",
      "MongoDB"
    ],
    "benefits": [
      "Competitive salary",
      "Health insurance"
    ]
  }
}
```

### Example Response:
```json
{
  "status": "success",
  "data": {
    "evaluation": {
      "overallScore": 85,
      "matchPercentage": 85,
      "skillsMatch": {
        "score": 90,
        "matched": ["Node.js", "React"],
        "missing": ["MongoDB"]
      },
      "experienceMatch": {
        "score": 80,
        "relevantExperience": [
          {
            "position": "Senior Developer",
            "company": "Previous Corp",
            "relevance": 85,
            "comment": "Highly relevant experience in similar role"
          }
        ]
      }
    }
  }
} 